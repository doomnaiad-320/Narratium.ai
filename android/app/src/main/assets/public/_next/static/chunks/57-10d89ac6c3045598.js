"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[57],{5618:(t,e,r)=>{r.d(e,{x:()=>i});var a=r(93362);let n={enabled:!0,applyToPrompt:!1,applyToResponse:!0};class i{static async getRegexScriptStore(){try{return(await (0,a.v3)(a.CZ))[0]||{}}catch(t){return console.error("Error reading regex scripts:",t),{}}}static async saveRegexScriptStore(t){try{return await (0,a.Mr)(a.CZ,[t]),!0}catch(t){return console.error("Error saving regex scripts:",t),!1}}static async getRegexScripts(t){try{return(await this.getRegexScriptStore())[t]||null}catch(t){return console.error("Error getting regex scripts:",t),null}}static async updateRegexScript(t,e,r){let a=await this.getRegexScripts(t);return!!a&&!!a[e]&&(a[e]={...a[e],...r},this.updateOwnerScripts(t,a))}static async addRegexScript(t,e){let r=await this.getRegexScripts(t)||{},a="script_".concat(Object.keys(r).length,"_").concat(Date.now().toString().slice(-4)),n={...e,id:a};return r[a]=n,await this.updateOwnerScripts(t,r)?a:null}static async deleteRegexScript(t,e){let r=await this.getRegexScripts(t);return!!r&&!!r[e]&&(delete r[e],this.updateOwnerScripts(t,r))}static async updateOwnerScripts(t,e){let r=await this.getRegexScriptStore();return r[t]=e,this.saveRegexScriptStore(r)}static async updateRegexScripts(t,e){let r=await this.getRegexScriptStore(),a=t=>({...t,disabled:t.disabled||!1,scriptName:t.scriptName||"Unnamed Script",trimStrings:t.trimStrings||[],placement:t.placement||[999]}),n=Array.isArray(e)?e.reduce((t,e,r)=>{if(!e.findRegex)return console.warn("Skipping invalid regex script",e),t;let n=a(e);return{...t,["script_".concat(r)]:n}},{}):Object.fromEntries(Object.entries(e).map(t=>{let[e,r]=t;return r.findRegex?[e,a(r)]:(console.warn("Skipping invalid regex script",r),[e,null])}).filter(t=>{let[e,r]=t;return null!==r}));return r[t]=n,await this.saveRegexScriptStore(r),!0}static async getRegexScriptSettings(t){let e=(await this.getRegexScriptStore())["".concat(t,"_settings")];return e?{...n,...e}:{...n}}static async updateRegexScriptSettings(t,e){let r=await this.getRegexScriptStore(),a={...await this.getRegexScriptSettings(t),...e};return r["".concat(t,"_settings")]=a,await this.saveRegexScriptStore(r),a}static async getAllScriptsForProcessing(t){let e=await this.getRegexScripts(t)||{},r=await this.getRegexScripts("global")||{};return[...Object.values(e),...Object.values(r)]}}},18324:(t,e,r)=>{r.d(e,{x:()=>s});var a=r(93362);class n{constructor(t,e,r,a,n,i,o=new Date().toISOString()){this.node_id=t,this.parent_node_id=e,this.user_input=r,this.assistant_response=a,this.full_response=n,this.parsed_content=i,this.created_at=o}}class i{constructor(t,e,r=[],a="root",n=new Date().toISOString(),i=new Date().toISOString()){this.id=t,this.character_id=e,this.nodes=r,this.current_node_id=a,this.created_at=n,this.updated_at=i}}var o=r(51368);class s{static async createDialogueTree(t){let e=(await (0,a.v3)(a.Vx)).filter(e=>e.character_id!==t),r=new i(t,t,[],"root");return e.push(r),await (0,a.Mr)(a.Vx,e),await this.addNodeToDialogueTree(t,"","","","",void 0,"root"),r}static async getDialogueTreeById(t){var e;let r=(await (0,a.v3)(a.Vx)).find(e=>e.id===t);return r?new i(r.id,r.character_id,(null===(e=r.nodes)||void 0===e?void 0:e.map(t=>new n(t.node_id,t.parent_node_id,t.user_input,t.assistant_response,t.full_response,t.parsed_content,t.created_at)))||[],r.current_node_id,r.created_at,r.updated_at):null}static async addNodeToDialogueTree(t,e,r,i,s,c,d){let l=await (0,a.v3)(a.Vx),u=l.findIndex(e=>e.id===t);d||(d=(0,o.A)());let g=new n(d,e,r,i,s,c);return l[u].nodes||(l[u].nodes=[]),l[u].nodes.push(g),l[u].current_node_id=d,l[u].updated_at=new Date().toISOString(),await (0,a.Mr)(a.Vx,l),d}static async updateDialogueTree(t,e){let r=await (0,a.v3)(a.Vx),n=r.findIndex(e=>e.id===t);return -1!==n&&(r[n]={...e,updated_at:new Date().toISOString()},await (0,a.Mr)(a.Vx,r),!0)}static async updateNodeInDialogueTree(t,e,r){let a=await this.getDialogueTreeById(t);if(!a)return null;let n=a.nodes.findIndex(t=>t.node_id===e);return -1===n?null:(a.nodes[n]={...a.nodes[n],...r},a.updated_at=new Date().toISOString(),await this.updateDialogueTree(t,a),a)}static async switchBranch(t,e){let r=await this.getDialogueTreeById(t);return r&&r.nodes.find(t=>t.node_id===e)?(r.current_node_id=e,r.updated_at=new Date().toISOString(),await this.updateDialogueTree(t,r),r):null}static async clearDialogueHistory(t){let e=await this.getDialogueTreeById(t);return e?(e.nodes=[],e.current_node_id="root",e.updated_at=new Date().toISOString(),await this.updateDialogueTree(t,e),e):null}static async deleteDialogueTree(t){let e=await (0,a.v3)(a.Vx),r=e.length,n=e.filter(e=>e.id!==t);return n.length!==r&&(await (0,a.Mr)(a.Vx,n),!0)}static async deleteNode(t,e){let r=await this.getDialogueTreeById(t);if(!r||"root"===e)return null;let a=r.nodes.find(t=>t.node_id===e);if(!a)return null;let n=new Set,i=t=>{n.add(t),r.nodes.filter(e=>e.parent_node_id===t).forEach(t=>i(t.node_id))};return i(e),r.nodes=r.nodes.filter(t=>!n.has(t.node_id)),n.has(r.current_node_id)&&(r.current_node_id=a.parent_node_id,r.nodes.find(t=>t.node_id===r.current_node_id)),r.updated_at=new Date().toISOString(),await this.updateDialogueTree(t,r),r}static async getDialoguePathToNode(t,e){let r=await this.getDialogueTreeById(t);if(!r)return[];let a=[],n=r.nodes.find(t=>t.node_id===e);for(;n&&(a.unshift(n),"root"!==n.node_id);)n=r.nodes.find(t=>t.node_id===(null==n?void 0:n.parent_node_id));return a}static async getChildNodes(t,e){let r=await this.getDialogueTreeById(t);return r?r.nodes.filter(t=>t.parent_node_id===e):[]}static async getAllDialoguesForCharacter(t){return(await (0,a.v3)(a.Vx)).filter(e=>e.character_id===t).map(t=>this.convertToDialogueTree(t))}static convertToDialogueTree(t){var e;return new i(t.id,t.character_id,(null===(e=t.nodes)||void 0===e?void 0:e.map(t=>new n(t.node_id,t.parent_node_id,t.user_input,t.assistant_response,t.response_summary,t.parsed_content,t.created_at)))||[],t.current_node_id,t.created_at,t.updated_at)}static async getSystemMessage(t){let e=await this.getDialogueTreeById(t);if(!e||!e.nodes||0===e.nodes.length)return"";let r=e.nodes.find(t=>"root"===t.parent_node_id);return(null==r?void 0:r.assistant_response)||""}static async getLastNodeId(t){let e=await this.getDialogueTreeById(t);return(null==e?void 0:e.current_node_id)||"root"}static async nodeExists(t,e){if("root"===e)return!0;let r=await this.getDialogueTreeById(t);return!!r&&!!r.nodes&&0!==r.nodes.length&&r.nodes.some(t=>t.node_id===e)}}},18564:(t,e,r)=>{r.d(e,{Q:()=>i});var a=r(93362),n=r(18324);class i{static async createCharacter(t,e,r){let n=await (0,a.v3)(a.UI),i={id:t,data:e,imagePath:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return n.push(i),await (0,a.Mr)(a.UI,n),i}static async getAllCharacters(){return await (0,a.v3)(a.UI)}static async getCharacterById(t){return(await (0,a.v3)(a.UI)).find(e=>e.id===t)}static async updateCharacter(t,e){let r=await (0,a.v3)(a.UI),n=r.findIndex(e=>e.id===t);return -1===n?null:(r[n].data={...r[n].data,...e},r[n].updated_at=new Date().toISOString(),await (0,a.Mr)(a.UI,r),r[n])}static async deleteCharacter(t){let e=await (0,a.v3)(a.UI),r=e.length,i=e.filter(e=>e.id!==t);return i.length!==r&&(await (0,a.Mr)(a.UI,i),await n.x.deleteDialogueTree(t),!0)}}},25014:(t,e,r)=>{r.d(e,{JR:()=>i,Mh:()=>s,Sl:()=>a,h1:()=>n,w:()=>c});let a="G-KDEPSL9CJG",n=()=>{a&&(window.dataLayer||(window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},window.gtag("js",new Date),window.gtag("config",a,{page_path:window.location.pathname,anonymize_ip:!0})))},i=t=>{a&&"function"==typeof window.gtag&&window.gtag("config",a,{page_path:t})},o=(t,e)=>{a&&"function"==typeof window.gtag&&window.gtag("event",t,e)},s=(t,e)=>{o("button_click",{button_id:t,button_name:e,context:"UserInteraction"})},c=(t,e)=>{o("form_submit",{form_id:t,form_name:e,context:"UserInteraction"})}},37196:(t,e,r)=>{function a(t,e,r,a){let n=t.replace(/<br\s*\/?>/gi,"\n");return(n=n.replace(/{{user}}/g,null!=r?r:"zh"===e?"æˆ‘":"I")).replace(/{{char}}/g,null!=a?a:"")}function n(t,e,r){let n={...t},i=t.name||"";for(let t of["description","personality","first_mes","scenario","mes_example","creatorcomment","creator_notes"])if(n[t]){let o=a(n[t],e,r,i);n[t]=o}if(n.character_book){let t=Array.isArray(n.character_book)?n.character_book:n.character_book.entries||[];n.character_book=t.map(t=>{let n={...t};if(n.comment){let t=a(n.comment,e,r,i);n.comment=t}if(n.content){let t=a(n.content,e,r,i);n.content=t}return n})}if(Array.isArray(n.alternate_greetings))for(let t=0;t<n.alternate_greetings.length;t++){let o=n.alternate_greetings[t];o=a(o,e,r,i),n.alternate_greetings[t]=o}return n}r.d(e,{_:()=>n,y:()=>a})},57987:(t,e,r)=>{r.d(e,{H:()=>o});var a=r(95155),n=r(12115),i=r(93362);function o(t){let{avatarPath:e}=t,[r,o]=(0,n.useState)(null);return(0,n.useEffect)(()=>{let t;return async function(){let r=await (0,i.qW)(e);r?o(t=URL.createObjectURL(r)):console.warn("Avatar blob not found for",e)}(),()=>{t&&URL.revokeObjectURL(t)}},[e]),(0,a.jsx)("div",{className:"w-full h-full bg-cover bg-center rounded",style:{backgroundImage:r?"url(".concat(r,")"):void 0}})}},73153:(t,e,r)=>{r.d(e,{K:()=>i});var a=r(93362);let n={enabled:!0,maxEntries:5,contextWindow:5};class i{static async getWorldBooks(){return(await (0,a.v3)(a.w5))[0]||{}}static async saveWorldBooks(t){await (0,a.Mr)(a.w5,[t])}static async getWorldBook(t){try{return(await this.getWorldBooks())[t]||null}catch(t){return console.error("Error getting world book:",t),null}}static async updateWorldBook(t,e){let r=await this.getWorldBooks(),a=t=>{var e,r,a,n;return{...t,depth:null!==(a=null===(e=t.extensions)||void 0===e?void 0:e.depth)&&void 0!==a?a:1,position:null!==(n=null===(r=t.extensions)||void 0===r?void 0:r.position)&&void 0!==n?n:4}},n=Array.isArray(e)?e.reduce((t,e,r)=>{let n=a(e);return{...t,["entry_".concat(r)]:n}},{}):Object.fromEntries(Object.entries(e).map(t=>{let[e,r]=t;return[e,a(r)]}));return r[t]=n,await this.saveWorldBooks(r),!0}static async addWorldBookEntry(t,e){let r=await this.getWorldBook(t)||{},a="entry_".concat(Object.keys(r).length);return r[a]=e,await this.updateWorldBook(t,r)?a:null}static async updateWorldBookEntry(t,e,r){let a=await this.getWorldBook(t);return!!a&&!!a[e]&&(a[e]={...a[e],...r},this.updateWorldBook(t,a))}static async deleteWorldBookEntry(t,e){let r=await this.getWorldBook(t);return!!r&&!!r[e]&&(delete r[e],this.updateWorldBook(t,r))}static async getWorldBookSettings(t){let e=(await this.getWorldBooks())["".concat(t,"_settings")];return e?{...n,...e}:{...n}}static async updateWorldBookSettings(t,e){let r=await this.getWorldBooks(),a={...await this.getWorldBookSettings(t),...e};return r["".concat(t,"_settings")]=a,await this.saveWorldBooks(r),a}}},93362:(t,e,r)=>{r.d(e,{CZ:()=>s,Jt:()=>y,Mr:()=>u,UI:()=>a,Vx:()=>n,aU:()=>w,j$:()=>_,qW:()=>p,rH:()=>c,uv:()=>h,v3:()=>l,w5:()=>o});let a="characters_record",n="character_dialogues",i="character_images",o="world_book",s="regex_scripts",c="preset_data";function d(){return new Promise((t,e)=>{let r=indexedDB.open("CharacterAppDB",4);r.onerror=()=>e(r.error),r.onsuccess=()=>t(r.result),r.onupgradeneeded=()=>{let t=r.result;t.objectStoreNames.contains(a)||t.createObjectStore(a),t.objectStoreNames.contains(n)||t.createObjectStore(n),t.objectStoreNames.contains(i)||t.createObjectStore(i),t.objectStoreNames.contains(o)||t.createObjectStore(o),t.objectStoreNames.contains(s)||t.createObjectStore(s),t.objectStoreNames.contains(c)||t.createObjectStore(c)}})}async function l(t){await g();let e=await d();return new Promise((r,a)=>{let n=e.transaction(t,"readonly").objectStore(t).get("data");n.onsuccess=()=>r(n.result||[]),n.onerror=()=>a(n.error)})}async function u(t,e){await g();let r=await d();return new Promise((a,n)=>{let i=r.transaction(t,"readwrite").objectStore(t).put(e,"data");i.onsuccess=()=>a(),i.onerror=()=>n(i.error)})}async function g(){let t=await d(),e=[a,n,i,o,c,s];await Promise.all(e.map(e=>new Promise((r,a)=>{let n=t.transaction(e,"readwrite").objectStore(e),i=n.get("data");i.onsuccess=()=>{if(void 0===i.result){let t=n.put([],"data");t.onsuccess=()=>r(),t.onerror=()=>a(t.error)}else r()},i.onerror=()=>a(i.error)})))}async function w(t,e){await g();let r=await d();return new Promise((a,n)=>{let o=r.transaction(i,"readwrite").objectStore(i).put(e,t);o.onsuccess=()=>a(),o.onerror=()=>n(o.error)})}async function p(t){await g();let e=await d();return new Promise((r,a)=>{let n=e.transaction(i,"readonly").objectStore(i).get(t);n.onsuccess=()=>r(n.result||null),n.onerror=()=>a(n.error)})}async function _(t){await g();let e=await d();return new Promise((r,a)=>{let n=e.transaction(i,"readwrite").objectStore(i).delete(t);n.onsuccess=()=>r(),n.onerror=()=>a(n.error)})}async function h(){let t=await d(),e={};for(let t of[a,n,o,s]){let r=await l(t);e[t]=r}await l(i);let r=[],c=t.transaction(i,"readonly").objectStore(i);for(let t of(await new Promise(t=>{let e=c.getAllKeys();e.onsuccess=()=>t(e.result)}))){let e=await p(t);if(e&&e instanceof Blob)try{let a=await S(e);r.push({key:t,data:a})}catch(e){console.error("Failed to convert image ".concat(t," to base64:"),e)}}return e[i]=r,e}async function y(t){for(let e of(await d(),[a,n,o,s]))t[e]&&await u(e,t[e]);if(t[i]){for(let e of t[i])if("string"==typeof e.data){let t=await f(e.data);await w(e.key,t)}}}async function S(t){if(!(t instanceof Blob))throw Error("Input is not a valid Blob object");return new Promise((e,r)=>{let a=new FileReader;a.onloadend=()=>{"string"==typeof a.result?e(a.result):r(Error("Failed to convert blob to base64"))},a.onerror=r,a.readAsDataURL(t)})}async function f(t){return(await fetch(t)).blob()}}}]);